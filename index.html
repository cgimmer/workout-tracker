<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Workout Tracker">
    
    <!-- App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiM2MzY2ZjEiLz4KPHN2ZyB4PSI0NSIgeT0iNjAiIHdpZHRoPSI5MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI1NiAyNTYiIGZpbGw9IndoaXRlIj4KPHA+CjxwYXRoIGQ9Ik0yNDgsMTIwaC04Vjg4YTE2LDE2LDAsMCwwLTE2LTE2SDIwOFY2NGExNiwxNiwwLDAsMC0xNi0xNkgxNjhhMTYsMTYsMCwwLDAtMTYsMTZ2NTZIMTA0VjY0QTE2LDE2LDAsMCwwLDg4LDQ4SDY0QTE2LDE2LDAsMCwwLDQ4LDY0djhIMzJBMTYsMTYsMCwwLDAsMTYsODh2MzJIOGE4LDgsMCwwLDAsMCwxNmg4djMyYTE2LDE2LDAsMCwwLDE2LDE2SDQ4djhhMTYsMTYsMCwwLDAsMTYsMTZIODhhMTYsMTYsMCwwLDAsMTYtMTZWMTM2aDQ4djU2YTE2LDE2LDAsMCwwLDE2LDE2aDI0YTE2LDE2LDAsMCwwLDE2LTE2di04aDE2YTE2LDE2LDAsMCwwLDE2LTE2VjEzNmg4YTgsOCwwLDAsMCwwLTE2Wk0zMiwxNjhWODhINDh2ODBabTU2LDI0SDY0VjY0SDg4VjE5MlptMTA0LDBIMTY4VjY0aDI0VjE3NS44MmMwLC4wNiwwLC4xMiwwLC4xOHMwLC4xMiwwLC4xOFYxOTJabTMyLTI0SDIwOFY4OGgxNloiLz4KPC9wPgo8L3N2Zz4KPC9zdmc+">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzYzNjZmMSIvPgo8c3ZnIHg9IjgiIHk9IjEwIiB3aWR0aD0iMTYiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAyNTYgMjU2IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0yNDgsMTIwaC04Vjg4YTE2LDE2LDAsMCwwLTE2LTE2SDIwOFY2NGExNiwxNiwwLDAsMC0xNi0xNkgxNjhhMTYsMTYsMCwwLDAtMTYsMTZ2NTZIMTA0VjY0QTE2LDE2LDAsMCwwLDg4LDQ4SDY0QTE2LDE2LDAsMCwwLDQ4LDY0djhIMzJBMTYsMTYsMCwwLDAsMTYsODh2MzJIOGE4LDgsMCwwLDAsMCwxNmg4djMyYTE2LDE2LDAsMCwwLDE2LDE2SDQ4djhhMTYsMTYsMCwwLDAsMTYsMTZIODhhMTYsMTYsMCwwLDAsMTYtMTZWMTM2aDQ4djU2YTE2LDE2LDAsMCwwLDE2LDE2aDI0YTE2LDE2LDAsMCwwLDE2LTE2di04aDE2YTE2LDE2LDAsMCwwLDE2LTE2VjEzNmg4YTgsOCwwLDAsMCwwLTE2Wk0zMiwxNjhWODhINDh2ODBabTU2LDI0SDY0VjY0SDg4VjE5MlptMTA0LDBIMTY4VjY0aDI0VjE3NS44MmMwLC4wNiwwLC4xMiwwLC4xOHMwLC4xMiwwLC4xOFYxOTJabTMyLTI0SDIwOFY4OGgxNloiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiV29ya291dCBUcmFja2VyIiwic2hvcnRfbmFtZSI6IldvcmtvdXQiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJ0aGVtZV9jb2xvciI6IiM2MzY2ZjEiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNakEwSWlCb1pXbG5hSFE5SWpJd05DSWdkbWxsZDBKdmVEMGlNQ0F3SURJME5DQXlOREFpSUdacGJHdzlJaU5qWkRFME1qWWlQanh5WldOMElIZzlJalkwSWlCNVBTSTJOQ0lnZDJsa2RHZzlJakUyTUNJZ2FHVnBaMmgwUFNJeE5qQWlJSEo0UFNJNElpQm1hV3hzUFNJak5qTTJObVl4SWk4K1BIUmxlSFFnZUQwaU1URXlJaUI1UFNJeE5qQWlJSFJoZVMxaGJtTm9iM0k5SW0xcFpHUnNaU0lnWm1sc2JEMGlJM1ptWm1abVppSWdabTl1ZEMxemFYcGxQU0l5TkNJZ1ptOXVkQzEzWldsbmFIUTlJbUp2YkdRaVBqa3VNVHc2ZEdWNGRENGdkRzlzYVdObGJqd3ZkR1Y0ZEQ0OEwzTjJaejRnIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100vw;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 60px 20px 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content {
            flex: 1;
            padding: 20px;
        }

        .workout-list {
            space-y: 8px;
        }

        .workout-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .workout-item:hover {
            background: #f8fafc;
            border-color: #6366f1;
        }

        .workout-info h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .workout-info p {
            color: #64748b;
            font-size: 16px;
        }

        .workout-arrow {
            font-size: 20px;
            color: #64748b;
        }

        .add-button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #64748b;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 18px;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .exercise-list {
            margin: 20px 0;
        }

        .exercise-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .exercise-item:hover {
            background: #f8fafc;
        }

        .exercise-info h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .exercise-info p {
            color: #64748b;
            font-size: 14px;
        }

        .save-button {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .bottom-nav {
            display: flex;
            background: white;
            border-top: 1px solid #e2e8f0;
            padding: 12px 0;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            color: #64748b;
            transition: color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-item.active {
            color: #6366f1;
        }

        .nav-item .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item small {
            font-size: 12px;
            font-weight: 500;
        }

        .week-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: white;
            margin-bottom: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .week-nav button {
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 18px;
            color: #64748b;
        }

        .week-nav span {
            margin: 0 20px;
            font-size: 16px;
            font-weight: 600;
        }

        .section-header {
            background: #f1f5f9;
            color: #64748b;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            margin: 20px -20px 16px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-save {
            background: #6366f1;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .set-editor {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            background: white;
        }

        .set-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .set-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            width: 100%;
        }

        .set-input {
            padding: 12px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
            width: 100%;
            min-width: 0; /* Prevents inputs from growing beyond container */
            box-sizing: border-box;
        }

        .last-week-info {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Program Screen -->
        <div id="program-screen" class="screen">
            <div class="header">
                <h1>Workout Program</h1>
            </div>
            <div class="content">
                <div class="workout-list" id="workout-list">
                    <!-- Workouts will be populated here -->
                </div>
                <button class="add-button" onclick="showWorkoutForm()">
                    + Add Workout
                </button>
            </div>
        </div>

        <!-- Workout Form Screen -->
        <div id="workout-form-screen" class="screen hidden">
            <div class="header">
                <button class="back-button" onclick="showProgramScreen()">‹</button>
                <h1 id="workout-form-title">Add Workout</h1>
            </div>
            <div class="content">
                <form id="workout-form">
                    <div class="form-group">
                        <label class="form-label">Workout Name</label>
                        <input type="text" class="form-input" id="workout-name" placeholder="e.g., Upper A">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Scheduled Day</label>
                        <select class="form-select" id="workout-day">
                            <option value="">Select Day</option>
                            <option value="Sunday">Sunday</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Routine</label>
                        <div class="exercise-list" id="exercise-list">
                            <!-- Exercises will be populated here -->
                        </div>
                        <button type="button" class="add-button" onclick="showExerciseForm()">
                            + Add Exercise
                        </button>
                    </div>
                    <button type="button" class="save-button" onclick="saveWorkout()">
                        Save Workout
                    </button>
                </form>
            </div>
        </div>

        <!-- Exercise Form Screen -->
        <div id="exercise-form-screen" class="screen hidden">
            <div class="header">
                <button class="back-button" onclick="showWorkoutForm()">‹</button>
                <h1 id="exercise-form-title">Add Exercise</h1>
            </div>
            <div class="content">
                <form id="exercise-form">
                    <div class="form-group">
                        <label class="form-label">Exercise Name</label>
                        <input type="text" class="form-input" id="exercise-name" placeholder="e.g., Chest Press">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sets</label>
                        <input type="number" class="form-input" id="exercise-sets" placeholder="3" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rep Range</label>
                        <input type="text" class="form-input" id="exercise-reps" placeholder="6-12">
                    </div>
                    <div class="form-group">
                        <label class="form-label">RIR</label>
                        <input type="number" class="form-input" id="exercise-rir" placeholder="0" min="0">
                    </div>
                    <button type="button" class="save-button" onclick="saveExercise()">
                        Save Exercise
                    </button>
                </form>
            </div>
        </div>

        <!-- Log Screen -->
        <div id="log-screen" class="screen hidden">
            <div class="header">
                <h1>Workout Log</h1>
            </div>
            <div class="content">
                <div class="week-nav">
                    <button onclick="changeWeek(-1)">‹</button>
                    <span id="current-week">Jul 27/25 - Aug 2/25</span>
                    <button onclick="changeWeek(1)">›</button>
                </div>

                <div class="section-header">Scheduled</div>
                <div id="scheduled-workouts">
                    <!-- Scheduled workouts will be populated here -->
                </div>

                <div class="section-header">Completed</div>
                <div id="completed-workouts">
                    <!-- Completed workouts will be populated here -->
                </div>
            </div>
        </div>

        <!-- Workout Entry Screen -->
        <div id="workout-entry-screen" class="screen hidden">
            <div class="header">
                <button class="back-button" onclick="showLogScreen()">‹</button>
                <h1>Workout Entry</h1>
            </div>
            <div class="content">
                <div class="form-group">
                    <label class="form-label">Workout Name</label>
                    <input type="text" class="form-input" id="entry-workout-name" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Date Completed</label>
                    <input type="date" class="form-input" id="entry-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Exercises</label>
                    <div id="entry-exercise-list">
                        <!-- Exercise entries will be populated here -->
                    </div>
                </div>
                <button type="button" class="save-button" onclick="logWorkout()">
                    Log Workout
                </button>
            </div>
        </div>

        <!-- Set Entry Modal -->
        <div id="set-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="set-modal-title">Exercise Name</h3>
                    <p id="set-modal-subtitle">Log your sets</p>
                </div>
                <div id="set-editors">
                    <!-- Set editors will be populated here -->
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeSetModal()">Cancel</button>
                    <button class="btn-save" onclick="saveSetData()">Log Exercise</button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item" onclick="showLogScreen()">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                </div>
                <small>Log</small>
            </div>
            <div class="nav-item active" onclick="showProgramScreen()">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 256 256" fill="none" stroke="currentColor" stroke-width="0">
                        <path d="M248,120h-8V88a16,16,0,0,0-16-16H208V64a16,16,0,0,0-16-16H168a16,16,0,0,0-16,16v56H104V64A16,16,0,0,0,88,48H64A16,16,0,0,0,48,64v8H32A16,16,0,0,0,16,88v32H8a8,8,0,0,0,0,16h8v32a16,16,0,0,0,16,16H48v8a16,16,0,0,0,16,16H88a16,16,0,0,0,16-16V136h48v56a16,16,0,0,0,16,16h24a16,16,0,0,0,16-16v-8h16a16,16,0,0,0,16-16V136h8a8,8,0,0,0,0-16ZM32,168V88H48v80Zm56,24H64V64H88V192Zm104,0H168V64h24V175.82c0,.06,0,.12,0,.18s0,.12,0,.18V192Zm32-24H208V88h16Z" fill="currentColor"/>
                    </svg>
                </div>
                <small>Program</small>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let workouts = [];
        let currentWorkout = null;
        let currentExercise = null;
        let currentWeekStart = null;
        let completedWorkouts = [];
        let currentLogEntry = null;

        // Initialize app
        function init() {
            loadData();
            updateCurrentWeek();
            showLogScreen(); // Default to log screen
            renderProgram();
            renderLog();
        }

        // Data persistence
        function saveData() {
            const data = {
                workouts: workouts,
                completedWorkouts: completedWorkouts
            };
            // Using variables instead of localStorage for Claude.ai compatibility
            window.workoutData = data;
        }

        function loadData() {
            // Load from variables instead of localStorage for Claude.ai compatibility
            const data = window.workoutData || { workouts: [], completedWorkouts: [] };
            workouts = data.workouts || [];
            completedWorkouts = data.completedWorkouts || [];
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        function showProgramScreen() {
            showScreen('program-screen');
            renderProgram();
            document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        }

        function showLogScreen() {
            showScreen('log-screen');
            renderLog();
            document.querySelector('.nav-item:nth-child(1)').classList.add('active');
        }

        function showWorkoutForm(workout = null) {
            showScreen('workout-form-screen');
            
            if (workout) {
                currentWorkout = { ...workout }; // Create a copy
                document.getElementById('workout-form-title').textContent = workout.name;
                document.getElementById('workout-name').value = workout.name;
                document.getElementById('workout-day').value = workout.day;
                renderExerciseList();
            } else {
                document.getElementById('workout-form-title').textContent = 'Add Workout';
                document.getElementById('workout-form').reset();
                currentWorkout = { exercises: [] };
                renderExerciseList();
            }
        }

        function showExerciseForm(exercise = null) {
            currentExercise = exercise;
            showScreen('exercise-form-screen');
            
            if (exercise) {
                document.getElementById('exercise-form-title').textContent = exercise.name;
                document.getElementById('exercise-name').value = exercise.name;
                document.getElementById('exercise-sets').value = exercise.sets;
                document.getElementById('exercise-reps').value = exercise.reps;
                document.getElementById('exercise-rir').value = exercise.rir;
            } else {
                document.getElementById('exercise-form-title').textContent = 'Add Exercise';
                document.getElementById('exercise-form').reset();
                currentExercise = null;
            }
        }

        // Workout management
        function saveWorkout() {
            const name = document.getElementById('workout-name').value.trim();
            const day = document.getElementById('workout-day').value;
            
            if (!name || !day) {
                alert('Please fill in all fields');
                return;
            }

            if (!currentWorkout.exercises || currentWorkout.exercises.length === 0) {
                alert('Please add at least one exercise');
                return;
            }

            const workout = {
                id: currentWorkout.id || Date.now(),
                name: name,
                day: day,
                exercises: currentWorkout.exercises
            };

            if (currentWorkout.id) {
                // Update existing
                const index = workouts.findIndex(w => w.id === currentWorkout.id);
                workouts[index] = workout;
            } else {
                // Add new
                workouts.push(workout);
            }

            saveData();
            showProgramScreen();
        }

        function saveExercise() {
            const name = document.getElementById('exercise-name').value.trim();
            const sets = parseInt(document.getElementById('exercise-sets').value);
            const reps = document.getElementById('exercise-reps').value.trim();
            const rir = parseInt(document.getElementById('exercise-rir').value);
            
            if (!name || !sets || !reps || rir === '') {
                alert('Please fill in all fields');
                return;
            }

            const exercise = {
                id: currentExercise?.id || Date.now(),
                name: name,
                sets: sets,
                reps: reps,
                rir: rir
            };

            if (!currentWorkout.exercises) {
                currentWorkout.exercises = [];
            }

            if (currentExercise?.id) {
                // Update existing
                const index = currentWorkout.exercises.findIndex(e => e.id === currentExercise.id);
                currentWorkout.exercises[index] = exercise;
            } else {
                // Add new
                currentWorkout.exercises.push(exercise);
            }

            // Preserve the form values when returning to workout form
            const workoutName = document.getElementById('workout-name').value;
            const workoutDay = document.getElementById('workout-day').value;
            
            currentWorkout.name = workoutName;
            currentWorkout.day = workoutDay;

            showWorkoutForm(currentWorkout);
        }

        // Rendering functions
        function renderProgram() {
            const container = document.getElementById('workout-list');
            container.innerHTML = '';

            workouts.forEach(workout => {
                const item = document.createElement('div');
                item.className = 'workout-item';
                item.onclick = () => showWorkoutForm(workout);
                
                item.innerHTML = `
                    <div class="workout-info">
                        <h3>${workout.name}</h3>
                        <p>${workout.day}</p>
                    </div>
                    <div class="workout-arrow">›</div>
                `;
                
                container.appendChild(item);
            });
        }

        function renderExerciseList() {
            const container = document.getElementById('exercise-list');
            container.innerHTML = '';

            if (currentWorkout.exercises) {
                currentWorkout.exercises.forEach(exercise => {
                    const item = document.createElement('div');
                    item.className = 'exercise-item';
                    item.onclick = () => showExerciseForm(exercise);
                    
                    item.innerHTML = `
                        <div class="exercise-info">
                            <h4>${exercise.name}</h4>
                            <p>${exercise.sets} sets | ${exercise.reps} reps | ${exercise.rir} RIR</p>
                        </div>
                        <div class="workout-arrow">›</div>
                    `;
                    
                    container.appendChild(item);
                });
            }
        }

        // Week management
        function updateCurrentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - dayOfWeek);
            // Reset time to midnight to avoid timezone issues
            currentWeekStart.setHours(0, 0, 0, 0);
            updateWeekDisplay();
        }

        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            // Ensure we maintain midnight time
            currentWeekStart.setHours(0, 0, 0, 0);
            updateWeekDisplay();
            renderLog();
        }

        function updateWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const formatDate = (date) => {
                const month = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                              'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][date.getMonth()];
                return `${month} ${date.getDate()}/${date.getFullYear().toString().slice(-2)}`;
            };
            
            document.getElementById('current-week').textContent = 
                `${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}`;
        }

        function renderLog() {
            renderScheduledWorkouts();
            renderCompletedWorkouts();
        }

        function renderScheduledWorkouts() {
            const container = document.getElementById('scheduled-workouts');
            container.innerHTML = '';
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // Get current week's date range for comparison
            const weekStart = new Date(currentWeekStart);
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const weekStartString = weekStart.toISOString().split('T')[0];
            const weekEndString = weekEnd.toISOString().split('T')[0];
            
            days.forEach((day, dayIndex) => {
                const workout = workouts.find(w => w.day === day);
                if (workout) {
                    // Calculate the correct date for this day of the week
                    const workoutDate = new Date(currentWeekStart);
                    workoutDate.setDate(currentWeekStart.getDate() + dayIndex);
                    workoutDate.setHours(0, 0, 0, 0); // Reset time to midnight
                    
                    // Check if this workout was completed ANYWHERE in this week (not just on the scheduled day)
                    const isCompletedThisWeek = completedWorkouts.some(cw => 
                        cw.workoutId === workout.id && 
                        cw.date >= weekStartString && 
                        cw.date <= weekEndString
                    );
                    
                    if (!isCompletedThisWeek) {
                        const item = document.createElement('div');
                        item.className = 'workout-item';
                        item.onclick = () => startWorkoutEntry(workout, workoutDate);
                        
                        item.innerHTML = `
                            <div class="workout-info">
                                <h3>${workout.name}</h3>
                                <p>${day}</p>
                            </div>
                            <div class="workout-arrow">›</div>
                        `;
                        
                        container.appendChild(item);
                    }
                }
            });
            
            if (container.children.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No scheduled workouts</p>';
            }
        }

        function renderCompletedWorkouts() {
            const container = document.getElementById('completed-workouts');
            container.innerHTML = '';
            
            const weekStart = new Date(currentWeekStart);
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            // Convert to date strings for comparison
            const weekStartString = weekStart.toISOString().split('T')[0];
            const weekEndString = weekEnd.toISOString().split('T')[0];
            
            const thisWeekCompleted = completedWorkouts.filter(cw => {
                return cw.date >= weekStartString && cw.date <= weekEndString;
            });
            
            thisWeekCompleted.forEach(completed => {
                const workout = workouts.find(w => w.id === completed.workoutId);
                if (workout) {
                    const item = document.createElement('div');
                    item.className = 'workout-item';
                    item.onclick = () => viewCompletedWorkout(completed);
                    
                    // Parse the date properly
                    const date = new Date(completed.date + 'T00:00:00');
                    const dateStr = date.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                    
                    item.innerHTML = `
                        <div class="workout-info">
                            <h3>${workout.name}</h3>
                            <p>${dateStr}</p>
                        </div>
                        <div class="workout-arrow">›</div>
                    `;
                    
                    container.appendChild(item);
                }
            });
            
            if (container.children.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No completed workouts</p>';
            }
        }

        // Workout entry
        function startWorkoutEntry(workout, date) {
            currentLogEntry = {
                workout: workout,
                date: date,
                completedWorkoutId: null, // This is a new workout entry
                exercises: workout.exercises.map(ex => ({
                    ...ex,
                    completed: false,
                    loggedSets: []
                }))
            };
            
            showScreen('workout-entry-screen');
            document.getElementById('entry-workout-name').value = workout.name;
            document.getElementById('entry-date').value = date.toISOString().split('T')[0];
            renderEntryExercises();
        }

        function renderEntryExercises() {
            const container = document.getElementById('entry-exercise-list');
            container.innerHTML = '';
            
            currentLogEntry.exercises.forEach((exercise, index) => {
                const item = document.createElement('div');
                item.className = 'exercise-item';
                item.onclick = () => showSetModal(exercise, index);
                
                let displayText;
                if (exercise.completed && exercise.loggedSets && exercise.loggedSets.length > 0) {
                    const reps = exercise.loggedSets.map(s => s.reps).join(', ');
                    const weights = exercise.loggedSets.map(s => s.weight).join(', ');
                    const rirs = exercise.loggedSets.map(s => s.rir).join('/');
                    displayText = `${reps} x ${weights} lbs, ${rirs} RIR`;
                } else {
                    displayText = `${exercise.sets} sets | ${exercise.reps} reps | ${exercise.rir} RIR`;
                }
                
                item.innerHTML = `
                    <div class="exercise-info">
                        <h4>${exercise.name}</h4>
                        <p>${displayText}</p>
                    </div>
                    <div class="workout-arrow">›</div>
                `;
                
                container.appendChild(item);
            });
        }

        // Set modal
        function showSetModal(exercise, exerciseIndex) {
            const modal = document.getElementById('set-modal');
            document.getElementById('set-modal-title').textContent = exercise.name;
            modal.setAttribute('data-exercise-index', exerciseIndex);
            
            // Initialize sets if not already done
            if (!exercise.loggedSets || exercise.loggedSets.length === 0) {
                exercise.loggedSets = [];
                for (let i = 0; i < exercise.sets; i++) {
                    exercise.loggedSets.push({
                        reps: '',
                        weight: '',
                        rir: exercise.rir
                    });
                }
            }
            
            renderSetEditors(exercise, exerciseIndex);
            modal.classList.add('show');
        }

        function renderSetEditors(exercise, exerciseIndex) {
            const container = document.getElementById('set-editors');
            container.innerHTML = '';
            
            exercise.loggedSets.forEach((set, setIndex) => {
                const setEditor = document.createElement('div');
                setEditor.className = 'set-editor';
                
                // Get last week's data for this exercise
                const lastWeekData = getLastWeekData(exercise.name, setIndex);
                const lastWeekSet = getLastWeekSetData(exercise.name, setIndex);
                
                // Pre-populate with last week's values if available and current values are empty
                const defaultReps = set.reps || (lastWeekSet ? lastWeekSet.reps : '');
                const defaultWeight = set.weight || (lastWeekSet ? lastWeekSet.weight : '');
                const defaultRir = set.rir !== undefined ? set.rir : (lastWeekSet ? lastWeekSet.rir : exercise.rir);
                
                setEditor.innerHTML = `
                    <div class="set-header">Set ${setIndex + 1}</div>
                    <div class="set-inputs">
                        <input type="number" class="set-input" placeholder="Reps" 
                               value="${defaultReps}" 
                               onchange="updateSetData(${exerciseIndex}, ${setIndex}, 'reps', this.value)">
                        <input type="number" class="set-input" placeholder="Weight" 
                               value="${defaultWeight}" 
                               onchange="updateSetData(${exerciseIndex}, ${setIndex}, 'weight', this.value)">
                        <input type="number" class="set-input" placeholder="RIR" 
                               value="${defaultRir}" 
                               onchange="updateSetData(${exerciseIndex}, ${setIndex}, 'rir', this.value)">
                    </div>
                    ${lastWeekData ? `<div class="last-week-info">Last week: ${lastWeekData}</div>` : ''}
                `;
                
                // Update the actual data with the defaults
                if (defaultReps) updateSetData(exerciseIndex, setIndex, 'reps', defaultReps);
                if (defaultWeight) updateSetData(exerciseIndex, setIndex, 'weight', defaultWeight);
                if (defaultRir !== '') updateSetData(exerciseIndex, setIndex, 'rir', defaultRir);
                
                container.appendChild(setEditor);
            });
        }

        function getLastWeekData(exerciseName, setIndex) {
            // Find the most recent completion of this exercise
            const lastWeek = new Date(currentWeekStart);
            lastWeek.setDate(lastWeek.getDate() - 7);
            
            // Create a copy and reverse it to search most recent first
            const reversedCompleted = [...completedWorkouts].reverse();
            
            for (let completed of reversedCompleted) {
                const completedDate = new Date(completed.date);
                if (completedDate < currentWeekStart) {
                    for (let ex of completed.exercises) {
                        if (ex.name === exerciseName && ex.sets && ex.sets[setIndex]) {
                            const set = ex.sets[setIndex];
                            return `${set.reps} reps of ${set.weight} lbs with ${set.rir} RIR`;
                        }
                    }
                }
            }
            return null;
        }

        function getLastWeekSetData(exerciseName, setIndex) {
            // Find the most recent completion of this exercise and return the actual set data
            const lastWeek = new Date(currentWeekStart);
            lastWeek.setDate(lastWeek.getDate() - 7);
            
            // Create a copy and reverse it to search most recent first
            const reversedCompleted = [...completedWorkouts].reverse();
            
            for (let completed of reversedCompleted) {
                const completedDate = new Date(completed.date);
                if (completedDate < currentWeekStart) {
                    for (let ex of completed.exercises) {
                        if (ex.name === exerciseName && ex.sets && ex.sets[setIndex]) {
                            return ex.sets[setIndex];
                        }
                    }
                }
            }
            return null;
        }

        function updateSetData(exerciseIndex, setIndex, field, value) {
            currentLogEntry.exercises[exerciseIndex].loggedSets[setIndex][field] = value;
        }

        function saveSetData() {
            const exerciseIndex = parseInt(document.getElementById('set-modal').getAttribute('data-exercise-index'));
            currentLogEntry.exercises[exerciseIndex].completed = true;
            closeSetModal();
            renderEntryExercises();
        }

        function closeSetModal() {
            document.getElementById('set-modal').classList.remove('show');
        }

        // Log workout
        function logWorkout() {
            const allCompleted = currentLogEntry.exercises.every(ex => ex.completed);
            
            if (!allCompleted) {
                alert('Please complete all exercises before logging the workout');
                return;
            }
            
            // Use the date from the form, but ensure it's properly formatted
            const dateValue = document.getElementById('entry-date').value;
            const completedDate = new Date(dateValue + 'T00:00:00'); // Add time to avoid timezone issues
            
            const completedWorkout = {
                id: currentLogEntry.completedWorkoutId || Date.now(), // Use existing ID if editing
                workoutId: currentLogEntry.workout.id,
                date: completedDate.toISOString().split('T')[0], // Store as YYYY-MM-DD string
                exercises: currentLogEntry.exercises.map(ex => ({
                    name: ex.name,
                    sets: ex.loggedSets
                }))
            };
            
            if (currentLogEntry.completedWorkoutId) {
                // Update existing completed workout
                const index = completedWorkouts.findIndex(cw => cw.id === currentLogEntry.completedWorkoutId);
                if (index !== -1) {
                    completedWorkouts[index] = completedWorkout;
                }
            } else {
                // Add new completed workout
                completedWorkouts.push(completedWorkout);
            }
            
            saveData();
            
            // TODO: Send to Google Sheets
            sendToGoogleSheets(completedWorkout);
            
            showLogScreen();
        }

        function sendToGoogleSheets(completedWorkout) {
            // Placeholder for Google Sheets integration
            console.log('Sending to Google Sheets:', completedWorkout);
            
            // Format data for sheets
            const sheetData = [];
            completedWorkout.exercises.forEach(exercise => {
                const reps = exercise.sets.map(s => s.reps).join(', ');
                const weights = exercise.sets.map(s => s.weight).join(', ');
                const rirs = exercise.sets.map(s => s.rir).join(', ');
                
                sheetData.push({
                    date: completedWorkout.date,
                    exercise: exercise.name,
                    reps: reps,
                    weight: weights,
                    rir: rirs
                });
            });
            
            console.log('Formatted for sheets:', sheetData);
        }

        function viewCompletedWorkout(completed) {
            // Find the original workout template
            const workout = workouts.find(w => w.id === completed.workoutId);
            if (!workout) return;
            
            // Set up the entry for editing
            currentLogEntry = {
                workout: workout,
                date: new Date(completed.date + 'T00:00:00'),
                completedWorkoutId: completed.id, // Track which completed workout we're editing
                exercises: workout.exercises.map(ex => {
                    // Find the completed exercise data
                    const completedEx = completed.exercises.find(cex => cex.name === ex.name);
                    return {
                        ...ex,
                        completed: !!completedEx,
                        loggedSets: completedEx ? completedEx.sets : []
                    };
                })
            };
            
            showScreen('workout-entry-screen');
            document.getElementById('entry-workout-name').value = workout.name;
            document.getElementById('entry-date').value = completed.date;
            renderEntryExercises();
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>